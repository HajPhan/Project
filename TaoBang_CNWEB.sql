
-- |================================================> Tao Bang <======================================================|

-- Tao bang NHANVIEN
CREATE TABLE NHANVIEN
(
	MANV INT PRIMARY KEY IDENTITY(15150001,1),
	HOTEN NVARCHAR(250),
	NGAYSINH DATE,
	GT NCHAR(5),
	SDT NCHAR(50),
	MAIL NCHAR(250),
	DIACHI NVARCHAR(250),
	NGAYLAM DATETIME,
	IMAGES NVARCHAR(250),
	TRANGTHAI INT
)
GO

-- Tao bang KHACHHANG
CREATE TABLE KHACHHANG
(
	MAKH INT PRIMARY KEY IDENTITY(12120001,1),
	TENKH NVARCHAR(50),
	NGAYSINH DATE,
	GT NCHAR(5),
	SDT INT,
	MAIL NCHAR(50),
	DIACHI NVARCHAR(100),
	NGAYDK DATETIME,
	TRANGTHAI INT
)
GO

-- Tao bang NHACC
CREATE TABLE NHACC
(
	MACC INT PRIMARY KEY IDENTITY(13130001,1),
	TENCC NVARCHAR(100),
	DIACHI NVARCHAR(100),
	SDT INT,
	TRANGTHAI INT
)
GO

-- Tao bang NHASX 
CREATE TABLE NHASX
(
	MASX INT PRIMARY KEY IDENTITY(14140001,1),
	TENSX NVARCHAR(50),
	QUOCGIA NVARCHAR(50),
	LOGO NVARCHAR(250),
	TRANGTHAI INT
)
GO

-- Tao bang LOAISP 
CREATE TABLE LOAISP
(
	MALOAI INT PRIMARY KEY IDENTITY(10110001,1),
	TENLOAI NVARCHAR(50),
	DVT NCHAR(10),
	TRANGTHAI INT
)
GO

-- Tao bang SANPHAM
CREATE TABLE SANPHAM
(
	MASP INT PRIMARY KEY IDENTITY(16160001,1),
	TENSP NVARCHAR(100),
	MASX INT,
	MALOAI INT,
	GIATHANH MONEY,
	IMAGES NVARCHAR(250),
	TRANGTHAI INT
)
GO

-- Tao bang CTSP
CREATE TABLE CTSP
(
	MASP INT,
	DoPhanGiaiManHinh NVARCHAR(250),
	CameraTruoc NVARCHAR(250),
	CameraSau NVARCHAR(250),
	TocDoCpu NVARCHAR(250),
	SoNhan NVARCHAR(250),
	Chipset NVARCHAR(250),
	Ram NVARCHAR(250),
	Gpu NVARCHAR(250),
	Rom NVARCHAR(250),
	KichThuoc NVARCHAR(250),
	CongNgheManHinh NVARCHAR(250),
	MauManHinh NVARCHAR(250),
	ChuanManHinh NVARCHAR(250),
	CongNgheCamUng NVARCHAR(250),
	MatKinhManHinh NVARCHAR(250),
	VideoCall NVARCHAR(250),
	DoPhanGiaiTruoc NVARCHAR(250),
	ThongTinKhac NVARCHAR(250),
	DoPhanGiaiSau NVARCHAR(250),
	QuayPhim NVARCHAR(250),
	DenFlash NVARCHAR(250),
	ChupAnhNangCao NVARCHAR(250),
	DanhBaLuTru NVARCHAR(250),
	TheNhoNgoai NVARCHAR(250),
	HoTroTheNhoToiDa NVARCHAR(250),
	KieuDang NVARCHAR(250),
	ChatLieu NVARCHAR(250),
	Trongluong NVARCHAR(250),
	KhaNangChongNuoc NVARCHAR(250),
	LoaiPin NVARCHAR(250),
	DungLuongPin NVARCHAR(250),
	PinCoTheThaoRoi NVARCHAR(250),
	ThoGianCho NVARCHAR(250),
	ThoiGianDamThoai NVARCHAR(250),
	CheDoSac NVARCHAR(250),
	MangInternet NVARCHAR(250),
	Wifi NVARCHAR(250),
	HoTroSim NVARCHAR(250),
	KheCamSim NVARCHAR(250),
	CPS NVARCHAR(250),
	Bluetooth NVARCHAR(250),
	NFC NVARCHAR(250),
	KetNoiUsb NVARCHAR(250),
	CongKetNoiKhac NVARCHAR(250),
	CongSac NVARCHAR(250),
	JackTaiKhe NVARCHAR(250),
	XemPhim NVARCHAR(250),
	NgheNhac NVARCHAR(250),
	GhiAm NVARCHAR(250),
	FMRadio NVARCHAR(250),
	DenPin NVARCHAR(250),
	UngDungKhac NVARCHAR(250)
)
GO

-- Tao bang DONDH 
CREATE TABLE DONDH
(
	MADH INT PRIMARY KEY IDENTITY(17170001,1),
	MANV INT,
	MAKH INT,
	NGDH DATE
)
GO

-- Tao bang CTDH 
CREATE TABLE CTDH
(
	MADH INT PRIMARY KEY,
	MASP INT,
	SLDH INT
)
GO

-- Tao bang PHIEUNHAP 
CREATE TABLE PHIEUNHAP 
(
	MAPN INT PRIMARY KEY IDENTITY(18180001,1),
	MANV INT,
	NGAYNHAP DATE,
	MACC INT
)
GO

-- Tao bang CTPN 
CREATE TABLE CTPN
(
	MAPN INT PRIMARY KEY,
	MASP INT,
	SLN INT,
	DONGIA MONEY
)
GO

-- Tao bang PHIEUXUAT
CREATE TABLE PHIEUXUAT
(
	MAPX INT PRIMARY KEY IDENTITY(19190001,1),
	MANV INT,
	MAKH INT,
	MADH INT,
	NGAYXUAT DATE
)
GO

-- Tao bang CTPX 
CREATE TABLE CTPX
(
	MAPX INT PRIMARY KEY,
	MASP INT,
	SLX INT,
	PHANTRAM REAL,
	THANHTIEN MONEY
)
GO

-- Tao bang TONKHO
CREATE TABLE TONKHO
(
	MONTH_YEAR DATE,
	MASP INT,
	TONGSLD INT,
	TONGSLN INT,
	TONGSLX INT,
	TONGSLT AS TONGSLD+TONGSLN-TONGSLX,
	PRIMARY KEY(MONTH_YEAR,MASP)
)
GO

-- Tao bang TAIKHOAN
CREATE TABLE TAIKHOAN
(
	MANV INT PRIMARY KEY,
	USERNAME NVARCHAR(250),
	PASSWORDS NVARCHAR(250) DEFAULT '123456',
	ISADMIN INT,
	ALLOWED INT
)
GO

-- Tao cac bang PHANQUYEN

CREATE TABLE DANHMUCCHUCNANG
(
	MADM NVARCHAR(350) PRIMARY KEY,
	TENDM NVARCHAR(350),
	MOTA NVARCHAR(350)
)
GO

CREATE TABLE VAITROCHUCNANG
(
	ID INT PRIMARY KEY IDENTITY(1,1),
	TENVAITRO NVARCHAR(250),
	MOTA NVARCHAR(250),
	MADM NVARCHAR(350)
)
GO

CREATE TABLE PHANQUYEN
(
	MANV INT,
	ID INT
	PRIMARY KEY (MANV,ID)
)
GO


CREATE TABLE ROLES
(
	ID NVARCHAR(250) PRIMARY KEY,
	NameId NVARCHAR(250),
	DISCRIPTION NVARCHAR(250)
)
GO



--| =================================================> Toa Khoa Ngoai <=================================================|

-- Tạo RBTV Khóa ngoại SANPHAM
ALTER TABLE dbo.SANPHAM 
	ADD CONSTRAINT FRK_SANPHAM_LOAISP 
	FOREIGN KEY(MALOAI) 
	REFERENCES dbo.LOAISP(MALOAI) 	
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

ALTER TABLE dbo.SANPHAM 
	ADD CONSTRAINT FRK_SANPHAM_NHASX 
	FOREIGN KEY(MASX) 
	REFERENCES dbo.NHASX(MASX)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO


-- Tao RBTV Khoa Ngoai CTSP
ALTER TABLE dbo.CTSP
	ADD CONSTRAINT FRK_CTSP_SANPHAM
	FOREIGN KEY(MASP)
	REFERENCES dbo.SANPHAM(MASP)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

-- sp_helpconstraint DONDH
-- Tạo RBTV khóa ngoại DONDH
ALTER TABLE dbo.DONDH 
	ADD CONSTRAINT FRK_DONDH_NHACC 
	FOREIGN KEY(MACC) 
	REFERENCES dbo.NHACC(MACC)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

ALTER TABLE dbo.DONDH
	ADD CONSTRAINT FRK_DONDH_NHANVIEN
	FOREIGN KEY(MANV)
	REFERENCES dbo.NHANVIEN(MANV)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO


-- Tạo RBTV Khóa ngoại CTDH
ALTER TABLE dbo.CTDH 
	ADD CONSTRAINT FRK_CTDH_SANPHAM 
	FOREIGN KEY(MASP) 
	REFERENCES dbo.SANPHAM(MASP)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

ALTER TABLE dbo.CTDH 
	ADD CONSTRAINT FRK_CTDH_DONDH 
	FOREIGN KEY(MADH) 
	REFERENCES dbo.DONDH(MADH)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO


-- Tạo RBTV Khóa ngoại PHIEUNHAP
ALTER TABLE dbo.PHIEUNHAP 
	ADD CONSTRAINT FRK_PHIEUNHAP_NHANVIEN 
	FOREIGN KEY(MANV) 
	REFERENCES dbo.NHANVIEN(MANV)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

ALTER TABLE dbo.PHIEUNHAP 
	ADD CONSTRAINT FRK_PHIEUNHAP_DONDH 
	FOREIGN KEY(MADH) 
	REFERENCES dbo.DONDH(MADH)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

-- Tạo RBTV Khóa ngoại CTPN
ALTER TABLE dbo.CTPN 
	ADD CONSTRAINT FRK_CTPN_PHIEUNHAP 
	FOREIGN KEY(MAPN) 
	REFERENCES dbo.PHIEUNHAP(MAPN)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

ALTER TABLE dbo.CTPN 
	ADD CONSTRAINT FRK_CTPN_SANPHAM 
	FOREIGN KEY(MASP) 
	REFERENCES dbo.SANPHAM(MASP)
	ON UPDATE NO ACTION
	ON DELETE NO ACTION
GO

-- Tạo RBTV Khóa ngoại PHIEUXUAT
ALTER TABLE dbo.PHIEUXUAT 
	ADD CONSTRAINT FRK_PHIEUXUAT_NHANVIEN 
	FOREIGN KEY(MANV) 
	REFERENCES dbo.NHANVIEN(MANV)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

ALTER TABLE dbo.PHIEUXUAT 
	ADD CONSTRAINT FRK_PHIEUXUAT_KHACHHANG 
	FOREIGN KEY(MAKH) 
	REFERENCES dbo.KHACHHANG(MAKH)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

-- Tạo RBTV Khóa ngoại CTPX
ALTER TABLE dbo.CTPX 
	ADD CONSTRAINT FRK_CTPX_PHIEUXUAT 
	FOREIGN KEY(MAPX) 
	REFERENCES dbo.PHIEUXUAT(MAPX)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

ALTER TABLE dbo.CTPX 
	ADD CONSTRAINT FRK_CTPX_SANPHAM 
	FOREIGN KEY(MASP) 
	REFERENCES dbo.SANPHAM(MASP)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

-- Tao RBTV khoa ngoai cho bang TONKHO
ALTER TABLE TONKHO 
	ADD CONSTRAINT FRK_TONKHO_SANPHAM 
	FOREIGN KEY(MASP) 
	REFERENCES dbo.SANPHAM(MASP)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

-- Tao RBTV khoa ngoai cho bang CTPQ
ALTER TABLE CTPQ
	ADD CONSTRAINT FRK_CTPQ_TAIKHOAN
	FOREIGN KEY(ID)
	REFERENCES TAIKHOAN(ID)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

ALTER TABLE CTPQ
	ADD CONSTRAINT FRK_CTPQ_PHANQUYEN
	FOREIGN KEY(MAQH)
	REFERENCES PHANQUYEN(MAQH)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

-- Tao RBTV khoa ngoai cho bang TAIKHOAN
ALTER TABLE TAIKHOAN
	ADD CONSTRAINT FRK_TAIKHOAN_NHANVIEN
	FOREIGN KEY(ID)
	REFERENCES dbo.NHANVIEN(MANV)
	ON UPDATE CASCADE
	ON DELETE NO ACTION
GO

-- Tao RBTV Khoa Ngoai CHUCNANG
--ALTER TABLE dbo.CHUCNANG 
--	ADD CONSTRAINT FRK_CHUCNANG_CTCN
--	FOREIGN KEY(MACN)
--	REFERENCES dbo.CTCN(MACN)
--GO


--ALTER TABLE dbo.CTCN 
--	ADD CONSTRAINT FRK_CTCN_PHANQUYEN
--	FOREIGN KEY(MAQH)
--	REFERENCES dbo.PHANQUYEN(MAQH)
--GO

-- |===================================================> RBTV DATA <======================================================|


-- sp_helpconstraint NHACC
-- Tao rang buoc RBTV cho bang NHACC
ALTER TABLE NHACC 
	ADD CONSTRAINT UNQ_NHACC_TENCC UNIQUE(TENCC),
	CONSTRAINT UNQ_NHACC_DIACHI UNIQUE(DIACHI),
	CONSTRAINT DEF_NHACC_SDT DEFAULT 'Chưa có' FOR SDT
GO

-- sp_helpconstraint NHASX
-- Tao rang buoc RBTV cho bang NHASX
ALTER TABLE dbo.NHASX
	ADD CONSTRAINT UNQ_NHASX_TENSX UNIQUE(TENSX)
GO

--`sp_helpconstraint SANPHAM
-- Tao RBTV cho bang SANPHAM 
ALTER TABLE dbo.SANPHAM
	ADD CONSTRAINT DEF_SANPHAM_GIATHANH DEFAULT '0' FOR GIATHANH
GO

-- sp_helpconstraint CTDH
-- Tao RBTV cho bang CTDH
ALTER TABLE CTDH 
	ADD CONSTRAINT CHK_CTDH_SLDH CHECK(SLDH>0)
GO

-- sp_helpconstraint CTPN
-- Tao RBTV cho bang CTPN
ALTER TABLE dbo.CTPN
	ADD CONSTRAINT CHK_CTPN_SLN CHECK(SLN>0)
	--CONSTRAINT CHK_CTPN_DONGIA CHECK(DONGIA>0)
GO



-- sp_helpconstraint CTPX
-- Tao RBTV cho bang CTPX
ALTER TABLE dbo.CTPX
	ADD CONSTRAINT CHK_CTPX_SLX CHECK(SLX > 0),
	CONSTRAINT CHK_CTPX_THANHTIEN CHECK(THANHTIEN > 0)
GO

-- sp_helpconstraint TONKHO
-- Tao RBTV cho bang TONKHO
ALTER TABLE TONKHO 
	ADD CONSTRAINT CHK_TONKHO_TONGSLD CHECK(TONGSLD>=0),
	CONSTRAINT CHK_TONKHO_TONGSLN CHECK(TONGSLN>=0),
	CONSTRAINT CHK_TONKHO_TONGSLX CHECK(TONGSLX>=0),
	CONSTRAINT DEF_TONKHO_TONGSLD DEFAULT '0' FOR TONGSLD,
	CONSTRAINT DEF_TONKHO_TONGSLN DEFAULT '0' FOR TONGSLN,
	CONSTRAINT DEF_TONKHO_TONGSLX DEFAULT '0' FOR TONGSLX
GO

/* Tao Store Procedure TESTING*/



-- |==================================================> SELECT <==========================================================|

-- Hien Thi Thong Tin CHI TIET QUYEN
CREATE PROCEDURE sp_SELECT_CHUCNANG
@MAQH NCHAR(50),
@MACN NCHAR(50),
@TENCHUCNANG NCHAR(50)
AS
BEGIN
	SELECT cn.INSERTS,cn.UPDATES,cn.DELETES,cn.SEARCHS,cn.PRINTS 
		FROM dbo.CHUCNANG AS cn 
		WHERE cn.MACN = @MACN AND cn.TENCHUCNANG=@TENCHUCNANG
END
GO


-- Hien Thi Thong Tin Phieu Nhap Theo Ma Don Hang
--CREATE PROCEDURE sp_Select_ThongTinPhieuXuatTheoMaDh
--@MADH INT
--AS
--BEGIN
--SELECT dh.MADH, ctdh.MASP, ctdh.SLDH FROM dbo.DONDH AS dh
--	JOIN dbo.CTDH AS ctdh
--	ON ctdh.MADH = @MADH AND dh.MADH = @MADH
--END
--GO

-- Hien thi Thong Tin San PHam va So Luong dat hang theo MADH
CREATE PROCEDURE sp_Select_ThongTinDonHangChoPhieuNhap
@MADH INT
AS
BEGIN
    SELECT ctdh.MASP FROM dbo.DONDH AS dh
	JOIN dbo.CTDH AS ctdh
	ON ctdh.MADH = @MADH AND dh.MADH = @MADH
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctdh.MASP
END

-- Hien Thi So Dat Hang Cho Bang Phieu Nhap
CREATE PROCEDURE sp_HienThiSlDhChoBangPhieuNhap
@MADH INT,
@MASP INT
AS
BEGIN
	SELECT ctdh.SLDH FROM dbo.DONDH AS dh
		JOIN dbo.CTDH AS ctdh
		ON  ctdh.MADH = @MADH AND dh.MADH = @MADH
		JOIN dbo.SANPHAM sp
		ON sp.MASP = @MASP AND ctdh.MASP = @MASP    
END
GO

-- Hien Thi So Luong Ton Con Lai Theo Ma San Pham cho Phieu Xuat
CREATE PROCEDURE sp_HienThiTongSltTheoMaSp
@MASP INT
AS
BEGIN
	SELECT TONGSLT FROM dbo.TONKHO WHERE MASP = @MASP    
END
GO

-- Hien Thi Danh Sach Dong Dat HangCho Bang Phieu Nhap
CREATE PROCEDURE sp_HienThiDanhSachDonDhChoPhieuNhap
@MADH INT
AS
BEGIN
    IF(NOT EXISTS(SELECT *FROM dbo.DONDH AS dh JOIN dbo.PHIEUNHAP AS pn ON pn.MADH = @MADH AND dh.MADH = @MADH))
	BEGIN
		SELECT ctdh.SLDH, ctdh.MASP, 0 AS SLN, 0 AS MAPN, 0 AS DONGIA FROM dbo.DONDH AS dh
			JOIN dbo.CTDH AS ctdh
			ON ctdh.MADH = @MADH AND dh.MADH = @MADH
	END
	ELSE IF(EXISTS(SELECT *FROM dbo.DONDH AS dh JOIN dbo.PHIEUNHAP AS pn ON pn.MADH = @MADH AND dh.MADH = @MADH))
	BEGIN
		SELECT ctdh.SLDH, ctdh.MASP, ctpn.SLN, pn.MAPN, ctpn.DONGIA FROM dbo.DONDH AS dh
			JOIN dbo.CTDH AS ctdh
			ON ctdh.MADH = dh.MADH
			JOIN dbo.PHIEUNHAP AS pn
			ON pn.MADH = @MADH AND dh.MADH = @MADH
			JOIN dbo.CTPN AS ctpn
			ON ctpn.MAPN = pn.MAPN 
	END
	ELSE
	BEGIN
	    RAISERROR ('ERROR: NOT EXISTS MADH!',16,1)
		ROLLBACK TRAN
		RETURN
	END
END
GO




---- Hien Thi Don Dat Hang
--CREATE PROCEDURE sp_HienThiDonDatHang_MaDh
--AS
--BEGIN
--    SELECT dh.MADH FROM dbo.DONDH AS dh
--	JOIN dbo.CTDH AS ct
--	ON ct.MADH = dh.MADH
--END
--GO

----DROP PROCEDURE dbo.sp_HienThiDonDatHang_MaDh
----DROP PROCEDURE dbo.sp_HienThiDonDatHang_MaNv
----DROP PROCEDURE dbo.sp_HienThiDonDatHang_MaSp
----DROP PROCEDURE dbo.sp_HienThiDonDatHang_MaCc
----DROP PROCEDURE dbo.sp_HienThiDonDatHang_SlDh

--CREATE PROCEDURE sp_HienThiDonDatHang_MaNv
--AS
--BEGIN
--    SELECT dh.MANV FROM dbo.DONDH AS dh
--	JOIN dbo.CTDH AS ct
--	ON ct.MADH = dh.MADH
--END
--GO


--CREATE PROCEDURE sp_HienThiDonDatHang_MaSp
--AS
--BEGIN
--    SELECT ct.MASP FROM dbo.DONDH AS dh
--	JOIN dbo.CTDH AS ct
--	ON ct.MADH = dh.MADH
--END
--GO


--CREATE PROCEDURE sp_HienThiDonDatHang_MaCc
--AS
--BEGIN
--    SELECT dh.MACC FROM dbo.DONDH AS dh
--	JOIN dbo.CTDH AS ct
--	ON ct.MADH = dh.MADH
--END
--GO


--CREATE PROCEDURE sp_HienThiDonDatHang_SlDh
--AS
--BEGIN
--    SELECT ct.SLDH FROM dbo.DONDH AS dh
--	JOIN dbo.CTDH AS ct
--	ON ct.MADH = dh.MADH
--END
--GO

-- Danh Sach Ton Kho
CREATE PROCEDURE sp_DanhSachTonKho
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,tk.TONGSLD,tk.TONGSLN, tk.TONGSLX, tk.TONGSLT FROM dbo.TONKHO AS tk 
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = tk.MASP
END
GO



--=====================================> INSERT TABLE FOR DATABASE <========================================================

---- tao Store Procedure CTPQ
CREATE PROCEDURE sp_Insert_CTPQ
@ID INT,
@MAQH CHAR(50)
AS
BEGIN
INSERT INTO dbo.CTPQ(ID,MAQH) VALUES(@ID,@MAQH)
END
GO


-- |================================================> Tao Procedure <=====================================================|

---- Tao Procedure Them Tai Khoan Nhan Vien
CREATE PROCEDURE sp_Insert_TaiKhoan_NhanVien
@ID INT,
@Pass INT
AS
BEGIN
	INSERT INTO TAIKHOAN VALUES(@ID,@Pass)
	--EXEC dbo.sp_Insert_TaiKhoan_LoginSQL @ID, @Pass
	EXEC dbo.sp_Insert_CTPQ @ID,'NVNEW'
END
GO

-- INSERT NHANVIEN
ALTER PROCEDURE sp_Insert_NhanVien
@Hoten NVARCHAR(50),
@NgaySinh DATE,
@Gt NCHAR(5),
@Sdt INT,
@Mail NCHAR(50),
@Diachi NVARCHAR(100),
@Ngaylam DATETIME
AS
BEGIN
    DECLARE @ID AS INT
	INSERT INTO NHANVIEN VALUES (@HOTEN,@NGAYSINH,@GT,@SDT,@MAIL,@DIACHI,@NGAYLAM)
	SELECT TOP 1 @ID = MANV FROM dbo.NHANVIEN ORDER BY MANV DESC
	EXEC sp_Insert_TaiKhoan_NhanVien @ID,@SDT
END
GO

-- INSERT KHACHHANG
CREATE PROCEDURE sp_Insert_KHACHHANG
@TENKH NVARCHAR(50),
@NGAYSINH DATE,
@GT NCHAR(5),
@SDT INT,
@MAIL NCHAR(50),
@DIACHI NVARCHAR(100),
@NGAYDK DATETIME
AS
BEGIN
	INSERT INTO KHACHHANG VALUES (@TENKH,@NGAYSINH,@GT,@SDT,@MAIL,@DIACHI,@NGAYDK)
END
GO

-- INSERT NHACC
CREATE PROCEDURE sp_Insert_NHACC
@TENCC NVARCHAR(100),
@DIACHI NVARCHAR(100),
@SDT INT
AS
BEGIN
	INSERT INTO NHACC VALUES(@TENCC,@DIACHI,@SDT)
END
GO

--- INSERT  NHASX
CREATE PROCEDURE sp_Insert_NHASX
@TENSX NVARCHAR(50),
@QUOCGIA NVARCHAR(50)
AS
BEGIN
      INSERT INTO NHASX VALUES(@TENSX,@QUOCGIA)
END
GO

-- INSERT LOAISP
CREATE PROCEDURE sp_Insert_LOAISP
@TENLOAI NVARCHAR(50),
@DVT NCHAR(10)
AS
BEGIN
		INSERT INTO LOAISP VALUES(@TENLOAI,@DVT)
END
GO

-- INSERT SANPHAM, INSERT CTSP
CREATE PROCEDURE sp_Insert_SANPHAM
@TENSP NVARCHAR(100),
@MASX INT,
@MALOAI INT,
@GIATHANH MONEY,
@CPU NVARCHAR(100),
@RAM NVARCHAR(100),
@OCUNG NVARCHAR(100),
@MANHINH NVARCHAR(100),
@CARD NVARCHAR(100),
@PORTCONNECT NVARCHAR(100),
@HDT NVARCHAR(100),
@AMTHANH NVARCHAR(100),
@DIAQUANG NVARCHAR(100),
@GIAOTIEP NVARCHAR(100),
@WEBCAM NVARCHAR(100),
@PIN NVARCHAR(100),
@TRONGLUONG NVARCHAR(100),
@BAOHANH NVARCHAR(100),
@NGAYNHAP DATE
AS
BEGIN
	DECLARE @iD AS INT
	INSERT INTO SANPHAM VALUES(@TENSP,@MASX,@MALOAI,@GIATHANH)
	SELECT TOP 1 @iD = MASP FROM dbo.SANPHAM ORDER BY MASP DESC
	INSERT INTO CTSP VALUES(@iD,@CPU,@RAM,@OCUNG,@CARD,@MANHINH,@PORTCONNECT,@HDT,@AMTHANH,@DIAQUANG,@GIAOTIEP,@WEBCAM,@PIN,@TRONGLUONG,@BAOHANH)
	EXEC sp_Insert_TONKHO @NGAYNHAP,@iD,0,0,0
END
GO



-- INSERT DONDH vs CTDH
CREATE PROCEDURE sp_Insert_DONDH
@MANV INT,
@MACC INT,
@MASP INT,
@SLDH INT,
@NGDH DATETIME
AS
BEGIN
	DECLARE @ID INT
	INSERT INTO DONDH VALUES (@MANV,@MACC,@NGDH)
	SELECT TOP 1 @ID=MADH FROM dbo.DONDH ORDER BY MADH DESC
	INSERT INTO CTDH VALUES(@ID,@MASP,@SLDH)
END
GO


-- INSERT PHIEUNHAP vs CTPN
CREATE PROCEDURE sp_Insert_PHIEUNHAP
@MANV INT,
@MADH INT,
@MASP INT,
@SLN INT,
@DONGIA MONEY,
@NGAYNHAP DATETIME
AS
BEGIN
	DECLARE @ID INT
	INSERT INTO PHIEUNHAP VALUES(@MANV,@NGAYNHAP,@MADH)
	SELECT TOP 1 @ID=MAPN FROM dbo.PHIEUNHAP ORDER BY MAPN DESC
	INSERT INTO CTPN VALUES(@ID,@MASP,@SLN,@DONGIA)
	--EXEC sp_Insert_TONKHO @NGAYNHAP,@MASP,0,@SLN,0
	UPDATE dbo.TONKHO
		SET TONGSLN=@SLN WHERE MASP=@MASP
END
GO

-- INSERT PHIEUXUAT vs CTPX
CREATE PROCEDURE sp_Insert_PHIEUXUAT
@MANV INT,
@MAKH INT,
@MASP INT,
@SLX INT,
--@DONGIA MONEY,
@NGAYXUAT DATETIME,
@PHANTRAM REAL
AS
BEGIN
	DECLARE @ID INT
	INSERT INTO PHIEUXUAT VALUES(@MANV,@MAKH,@NGAYXUAT)
	SELECT TOP 1 @ID=MAPX FROM dbo.PHIEUXUAT ORDER BY MAPX DESC
	INSERT INTO CTPX VALUES(@ID,@MASP,@SLX,@PHANTRAM,NULL)
	UPDATE dbo.TONKHO SET TONGSLX = @SLX WHERE MASP=@MASP
END
GO

-- Insert TonKho
CREATE PROCEDURE sp_Insert_TONKHO
@NGAYTHANG DATE,
@MASP INT,
@SLD INT,
@SLN INT,
@SLX INT
AS
BEGIN
    INSERT INTO TONKHO VALUES (@NGAYTHANG,@MASP,@SLD,@SLN,@SLX)
END
GO

-- INSERT PHANQUEN
CREATE PROCEDURE sp_Insert_PHANQUYEN
@MAQH NCHAR(50),
@TENQH NVARCHAR(100),
@GHICHU NVARCHAR(100)
AS
BEGIN
	INSERT INTO PHANQUYEN VALUES (@MAQH,@TENQH,@GHICHU)
END
GO

-- INSET CTCN
CREATE PROCEDURE sp_INSERT_CTCN_UPDATE_CHUCNANG
@MAQH NCHAR(50),
@DANHMUC BIT,
@QUANLYBANHANG BIT,
@THONGKE BIT,
@SAOLUU BIT,
@HELP BIT,
@MACN NCHAR(50),
@TENCHUCNANG NCHAR(100),
@INSERTS BIT,
@UPDATES BIT,
@DELETES BIT,
@SEARCHS BIT,
@PRINTS BIT,
@STATUS BIT
AS
BEGIN
	-- Insert Table CTCN
	IF(EXISTS(SELECT *FROM dbo.CTCN WHERE MAQH=@MAQH))
	BEGIN
		UPDATE dbo.CTCN SET MAQH=@MAQH, DANHMUC=@DANHMUC,QUANLYBANHANG=@QUANLYBANHANG,THONGKE=@THONGKE,SAOLUU=@SAOLUU,HELP=@HELP
		WHERE MAQH=@MAQH
	END
	ELSE
	BEGIN
		INSERT INTO dbo.CTCN VALUES (@MAQH,@DANHMUC,@QUANLYBANHANG,@THONGKE,@SAOLUU,@HELP)
	END

	-- Update CHUCNANG
	IF(EXISTS(SELECT *FROM dbo.CTCN WHERE DANHMUC=1))
	BEGIN
		UPDATE dbo.CHUCNANG 
		SET INSERTS=@INSERTS, UPDATES=@UPDATES, DELETES=@DELETES, SEARCHS=@SEARCHS, PRINTS=@PRINTS
		WHERE MACN=@MACN AND TENCHUCNANG=@TENCHUCNANG	
	END
	ELSE IF(EXISTS(SELECT *FROM dbo.CTCN WHERE QUANLYBANHANG=1))
	BEGIN
		UPDATE dbo.CHUCNANG 
		SET INSERTS=@INSERTS, UPDATES=@UPDATES, DELETES=@DELETES, SEARCHS=@SEARCHS, PRINTS=@PRINTS
		WHERE MACN=@MACN AND TENCHUCNANG=@TENCHUCNANG	
	END
	ELSE IF(EXISTS(SELECT *FROM dbo.CTCN WHERE THONGKE=1))
	BEGIN
		UPDATE dbo.CHUCNANG 
		SET INSERTS=@INSERTS, UPDATES=@UPDATES, DELETES=@DELETES, SEARCHS=@SEARCHS, PRINTS=@PRINTS
		WHERE MACN=@MACN AND TENCHUCNANG=@TENCHUCNANG	
	END
	ELSE IF(EXISTS(SELECT *FROM dbo.CTCN WHERE SAOLUU=1))
	BEGIN
		UPDATE dbo.CHUCNANG 
		SET INSERTS=@INSERTS, UPDATES=@UPDATES, DELETES=@DELETES, SEARCHS=@SEARCHS, PRINTS=@PRINTS
		WHERE MACN=@MACN AND TENCHUCNANG=@TENCHUCNANG	
	END
	ELSE IF(EXISTS(SELECT *FROM dbo.CTCN WHERE HELP=1))
	BEGIN
		UPDATE dbo.CHUCNANG 
		SET INSERTS=@INSERTS, UPDATES=@UPDATES, DELETES=@DELETES, SEARCHS=@SEARCHS, PRINTS=@PRINTS
		WHERE MACN=@MACN AND TENCHUCNANG=@TENCHUCNANG	
	END
	ELSE
	BEGIN
		RAISERROR(N'Lỗi Update Table CHUCNANG',16,1)
		ROLLBACK TRANSACTION
		RETURN
	END

END
GO





--=================================> UPDATE TABLE FOR DATABASE <===================================================

-- UPDATE FOR TABLE TAIKHOAN
CREATE PROCEDURE sp_UPDATE_TAIKHOAN
@ID INT,
@PASS INT
AS
BEGIN
    UPDATE dbo.TAIKHOAN SET Password=@PASS WHERE ID=@ID
END
GO

--  UPDATE FOR TABLE NHANVIEN
CREATE PROCEDURE sp_UPDATE_NHANVIEN
@HOTEN NVARCHAR(50),
@NGAYSINH DATE,
@GT NCHAR(5),
@SDT INT,
@MAIL NCHAR(50),
@DIACHI NVARCHAR(100),
@NGAYLAM DATETIME,
@MANV INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.NHANVIEN WHERE MANV=@MANV))
	BEGIN
		UPDATE dbo.NHANVIEN 
		SET HOTEN=@HOTEN,NGAYSINH=@NGAYSINH,GT=@GT,SDT=@SDT,MAIL=@MAIL,DIACHI=@DIACHI,NGAYLAM=@NGAYLAM
		WHERE MANV=@MANV
	END
	ELSE
	BEGIN
		PRINT 'MANV NOT EXITS !'
	END

END
GO

-- UPDATE TABLE FOR KHACHANG
CREATE PROCEDURE sp_UPDATE_KHACHHANG
@TENKH NVARCHAR(50),
@NGAYSINH DATE,
@GT NCHAR(5),
@SDT INT,
@MAIL NCHAR(50),
@DIACHI NVARCHAR(100),
@NGAYDK DATETIME,
@MAKH INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.KHACHHANG WHERE MAKH=@MAKH))
	BEGIN
		UPDATE dbo.KHACHHANG
		SET TENKH=@TENKH,NGAYSINH=@NGAYSINH,GT=@GT,SDT=@SDT,MAIL=@MAIL,DIACHI=@DIACHI,NGAYDK=@NGAYDK
		WHERE MAKH=@MAKH
	END
	ELSE
	BEGIN
		PRINT 'NOT EXITS KHACHHANG !'
	END

END
GO


-- UPDATE TABLE FOR NHACC
CREATE PROCEDURE sp_UPDATE_NHACC
@TENCC NVARCHAR(100),
@DIACHI NVARCHAR(100),
@SDT INT,
@MACC INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.NHACC WHERE MACC=@MACC))
	BEGIN
		UPDATE dbo.NHACC
		SET TENCC=@TENCC,DIACHI=@DIACHI,SDT=@SDT
		WHERE MACC=@MACC
	END
	ELSE
	BEGIN
		PRINT 'NOT EXITS NHACC !'
	END
END
GO


-- UPDATE TABLE FOR NHASX
CREATE PROCEDURE sp_UPDATE_NHASX
@TENSX NVARCHAR(100),
@QUOCGIA NVARCHAR(100),
@MASX INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.NHASX WHERE MASX=@MASX))
	BEGIN
		UPDATE dbo.NHASX
		SET TENSX=@TENSX,QUOCGIA=@QUOCGIA
		WHERE MASX=@MASX
	END
	ELSE
	BEGIN
		PRINT 'NOT EXITS NHASX !'
	END
END
GO


-- UPDATE TABLE FOR LOAISP
CREATE PROCEDURE sp_UPDATE_LOAISP
@TENLOAI NVARCHAR(50),
@DVT NCHAR(10),
@MALOAI INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.LOAISP WHERE MALOAI=@MALOAI))
	BEGIN
		UPDATE dbo.LOAISP
		SET TENLOAI=@TENLOAI,DVT=@DVT
		WHERE MALOAI=@MALOAI
	END
	ELSE
	BEGIN
		PRINT 'NOT EXITS LOAISP !'
	END
END
GO


-- UPDATE TO TABLE SANPHAM
ALTER PROCEDURE sp_UPDATE_SANPHAM
@TENSP NVARCHAR(100),
@MASX INT,
@MALOAI INT,
@GIATHANH MONEY,
@CPU NVARCHAR(100),
@RAM NVARCHAR(100),
@OCUNG NVARCHAR(100),
@MANHINH NVARCHAR(100),
@CARD NVARCHAR(100),
@PORTCONNECT NVARCHAR(100),
@HDT NVARCHAR(100),
@AMTHANH NVARCHAR(100),
@DIAQUANG NVARCHAR(100),
@GIAOTIEP NVARCHAR(100),
@WEBCAM NVARCHAR(100),
@PIN NVARCHAR(100),
@TRONGLUONG NVARCHAR(100),
@BAOHANH NVARCHAR(100),
@MASP INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.SANPHAM AS sp JOIN CTSP ct ON ct.MASP = @MASP AND sp.MASP=@MASP))
	BEGIN
		UPDATE dbo.SANPHAM
		SET TENSP=@TENSP, MASX=@MASX, MALOAI=@MALOAI,GIATHANH=@GIATHANH
		WHERE MASP=@MASP

		UPDATE CTSP
		SET CPU=@CPU,RAM=@RAM,OCUNG=@OCUNG,CARDMANHINH=@CARD,MANHINH=@MANHINH,PORTCONNECT=@PORTCONNECT,HDT=@HDT,AMTHANH=@AMTHANH,DIAQUANG=@DIAQUANG,GIAOTIEPMANG=@GIAOTIEP,WEBCAM=@WEBCAM,PIN=@PIN,TRONGLUONG=@TRONGLUONG,BAOHANH=@BAOHANH
		WHERE MASP=@MASP

	END
	ELSE
	BEGIN
		PRINT 'NOT EXITS SANPHAM !'
	END

END
GO


-- UPDATE TO TABLE DONDH as CTDH
CREATE PROCEDURE sp_UPDATE_DONDH
@MANV INT,
@MACC INT,
@MASP INT,
@SLDH INT,
@NGDH DATETIME,
@MADH INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.DONDH AS dh JOIN dbo.CTDH ct ON ct.MADH = dh.MADH))
	BEGIN
		UPDATE DONDH 
		SET MANV=@MANV,MACC=@MACC,NGDH=@NGDH
		WHERE MADH=@MADH

		UPDATE CTDH 
		SET MASP=@MASP,SLDH=@SLDH
		WHERE MADH=@MADH
	END
	ELSE
	BEGIN
	    PRINT 'NOT EXITS DONDH !'
	END
END
GO

-- UPDATE TO TABLE PHIEUNHAP as CTPN
CREATE PROCEDURE sp_UPDATE_PHIEUNHAP
@MANV INT,
@MADH INT,
@MASP INT,
@SLN INT,
@DONGIA MONEY,
@NGAYNHAP DATETIME,
@MAPN INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.PHIEUNHAP AS pn JOIN dbo.CTPN ON CTPN.MAPN = pn.MAPN))
	BEGIN
		UPDATE PHIEUNHAP 
		SET MANV=@MANV,NGAYNHAP=@NGAYNHAP,MADH=@MADH
		WHERE MAPN=@MAPN

		UPDATE CTPN 
		SET MASP=@MASP,SLN=@SLN,DONGIA=@DONGIA
		WHERE MAPN=@MAPN

		UPDATE dbo.TONKHO
		SET TONGSLN=@SLN WHERE MASP=@MASP
	END
END
GO


-- UPDATE TO TABLE PHIEUXUAT as CTPX
ALTER PROCEDURE sp_UPDATE_PHIEUXUAT
@MANV INT,
@MAKH INT,
@MASP INT,
@SLX INT,
--@MADH INT,
@PHANTRAM REAL,
@THANHTIEN MONEY,
@NGAYXUAT DATETIME,
@MAPX INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.PHIEUXUAT AS px JOIN dbo.CTPX ct ON ct.MAPX = px.MAPX))
	BEGIN
		UPDATE PHIEUXUAT 
		SET MANV=@MANV,MAKH=@MAKH,NGAYXUAT=@NGAYXUAT
		WHERE MAPX=@MAPX

		UPDATE CTPX 
		SET MASP=@MASP,SLX=@SLX,PHANTRAM = @PHANTRAM,THANHTIEN=@THANHTIEN
		WHERE MAPX=@MAPX

		UPDATE dbo.TONKHO
		SET TONGSLX=@SLX 
		WHERE MASP=@MASP
	END
END
GO

-- UPDATE TONKHO
CREATE PROCEDURE sp_UPDATE_TONKHO
@TONGSLD INT,
@MASP INT
AS
BEGIN
    UPDATE dbo.TONKHO SET TONGSLD=@TONGSLD WHERE MASP=@MASP
END
GO


-- UPDATE PHANQUYEN TO NHANVIEN
CREATE PROCEDURE sp_PHANQUYEN_NHANVIEN
@ID INT,
@MAQH NCHAR(50)
AS
BEGIN
	UPDATE CTPQ SET MAQH = @MAQH WHERE ID = @ID	
END
GO

-- UPDATE TABLE CHUCNANG






--|=================================> DELETE TABLE FOR DATABASE <=======================================================|

-- DELETE DATA FROM TABLE NHANVIEN
CREATE PROCEDURE sp_DELETE_NHANVIEN
@MANV INT
AS
BEGIN
	ALTER TABLE dbo.TAIKHOAN NOCHECK CONSTRAINT FRK_TAIKHOAN_NHANVIEN
	ALTER TABLE dbo.DONDH NOCHECK CONSTRAINT FRK_DONDH_NHANVIEN
	ALTER TABLE dbo.PHIEUNHAP NOCHECK CONSTRAINT FRK_PHIEUNHAP_NHANVIEN
	ALTER TABLE dbo.PHIEUXUAT NOCHECK CONSTRAINT FRK_PHIEUXUAT_NHANVIEN
	ALTER TABLE dbo.CTPQ NOCHECK CONSTRAINT FRK_CTPQ_PHANQUYEN
	DELETE FROM dbo.CTPQ WHERE ID=@MANV
	DELETE FROM dbo.TAIKHOAN WHERE ID=@MANV
	DELETE FROM dbo.NHANVIEN WHERE MANV=@MANV
	ALTER TABLE dbo.TAIKHOAN CHECK CONSTRAINT FRK_TAIKHOAN_NHANVIEN
	ALTER TABLE dbo.DONDH CHECK CONSTRAINT FRK_DONDH_NHANVIEN
	ALTER TABLE dbo.PHIEUNHAP CHECK CONSTRAINT FRK_PHIEUNHAP_NHANVIEN
	ALTER TABLE dbo.PHIEUXUAT CHECK CONSTRAINT FRK_PHIEUXUAT_NHANVIEN
	ALTER TABLE dbo.CTPQ CHECK CONSTRAINT FRK_CTPQ_PHANQUYEN
END
GO

-- DELETE DATA FROM TABLE KHACHHANG
CREATE PROCEDURE sp_DELETE_KHACHHANG
@MAKH INT
AS
BEGIN
	ALTER TABLE dbo.PHIEUXUAT NOCHECK CONSTRAINT FRK_PHIEUXUAT_KHACHHANG
	DELETE dbo.KHACHHANG WHERE MAKH=@MAKH
	ALTER TABLE dbo.PHIEUXUAT CHECK CONSTRAINT FRK_PHIEUXUAT_KHACHHANG
END
GO

-- DELETE DATA FROM TABLE NHACC
CREATE PROCEDURE sp_DELETE_NHACC
@MACC INT
AS
BEGIN
	ALTER TABLE dbo.DONDH NOCHECK CONSTRAINT FRK_DONDH_NHACC
	DELETE dbo.NHACC WHERE MACC=@MACC
	ALTER TABLE dbo.DONDH CHECK CONSTRAINT FRK_DONDH_NHACC
END
GO

-- DELETE DATA FROM TABLE NHASX
CREATE PROCEDURE sp_DELETE_NHASX
@MASX INT
AS
BEGIN
	ALTER TABLE dbo.SANPHAM NOCHECK CONSTRAINT FRK_SANPHAM_NHASX
	DELETE FROM dbo.NHASX WHERE MASX=@MASX
	ALTER TABLE dbo.SANPHAM CHECK CONSTRAINT FRK_SANPHAM_NHASX
END
GO

-- DELETE DATA FROM TABLE LOAISP
CREATE PROCEDURE sp_DELETE_LOAISP
@MALOAI INT
AS
BEGIN
	ALTER TABLE dbo.SANPHAM NOCHECK CONSTRAINT FRK_SANPHAM_LOAISP
	DELETE FROM dbo.LOAISP WHERE MALOAI=@MALOAI
	ALTER TABLE dbo.SANPHAM CHECK CONSTRAINT FRK_SANPHAM_LOAISP
END
GO

-- DELETE DATA FROM TABLE SANPHAM
CREATE PROCEDURE sp_DELETE_SANPHAM
@MASP INT
AS
BEGIN
	ALTER TABLE dbo.CTDH NOCHECK CONSTRAINT FRK_CTDH_SANPHAM
	ALTER TABLE dbo.CTPX NOCHECK CONSTRAINT FRK_CTPX_SANPHAM
	ALTER TABLE dbo.CTPN NOCHECK CONSTRAINT FRK_CTPN_SANPHAM
	ALTER TABLE dbo.TONKHO NOCHECK CONSTRAINT FRK_TONKHO_SANPHAM
	DELETE dbo.CTSP WHERE MASP=@MASP
	DELETE dbo.SANPHAM WHERE MASP=@MASP
	ALTER TABLE dbo.CTDH CHECK CONSTRAINT FRK_CTDH_SANPHAM
	ALTER TABLE dbo.CTPX CHECK CONSTRAINT FRK_CTPX_SANPHAM
	ALTER TABLE dbo.CTPN CHECK CONSTRAINT FRK_CTPN_SANPHAM
	ALTER TABLE dbo.TONKHO CHECK CONSTRAINT FRK_TONKHO_SANPHAM

END
GO


-- DELETE DATA FROM TABLE DONDH
CREATE PROCEDURE sp_DELETE_DONDH
@MADH INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.DONDH AS dh JOIN dbo.CTDH AS ct ON ct.MADH = @MADH AND dh.MADH=@MADH))
	BEGIN
		DELETE dbo.CTDH WHERE MADH=@MADH
		DELETE dbo.DONDH WHERE MADH=@MADH
	END
	ELSE
	BEGIN
		PRINT 'ERROR DELETE DONDH !'
	END

END
GO

-- DELETE DATA FROM TABLE PHIEUNHAP
CREATE PROCEDURE sp_DELETE_PHIEUNHAP
@MAPN INT,
@MASP INT
AS
BEGIN
	IF(EXISTS(SELECT*FROM dbo.PHIEUNHAP AS pn JOIN dbo.CTPN AS ct ON ct.MAPN = @MAPN AND pn.MAPN = @MAPN))
	BEGIN
		DELETE dbo.CTPN WHERE MAPN=@MAPN
		DELETE dbo.PHIEUNHAP WHERE MAPN=@MAPN

		DECLARE @sum INT, @sln INT
		SELECT @sln = SLN FROM dbo.CTPN WHERE MAPN = @MAPN
		SELECT @sum = TONGSLN FROM dbo.TONKHO WHERE MASP = @MASP
		UPDATE dbo.TONKHO SET TONGSLN = @sum - @sln WHERE MASP = @MASP
	END
	ELSE
	BEGIN
		PRINT 'ERROR DELETE PHIEUNHAP !'
		
	END

END
GO


-- DELETE DATA FROM TABLE PHIEUXUAT
CREATE PROCEDURE sp_DELETE_PHIEUXUAT
@MAPX INT,
@MASP INT
AS
BEGIN
	IF(EXISTS(SELECT *FROM dbo.PHIEUXUAT AS px JOIN dbo.CTPX ct ON ct.MAPX = @MAPX AND px.MAPX=@MAPX))
	BEGIN

		DELETE dbo.CTPX WHERE MAPX=@MAPX
		DELETE dbo.PHIEUXUAT WHERE MAPX=@MAPX
		DECLARE @slx INT, @sum INT
		SELECT @slx = SLX FROM dbo.CTPX WHERE MAPX=@MAPX
		SELECT @sum = TONGSLX FROM dbo.TONKHO WHERE MASP = @MASP
		UPDATE dbo.TONKHO SET TONGSLX = @sum - @slx WHERE MASP = @MASP
	END
	ELSE
	BEGIN
		PRINT 'ERROR DELETE PHIEUXUUAT !'
	END
END
GO


---===============================> SEARCH TABLE FOR DATABASE <==========================================================


-- SEARCH SAN PHAM THEO MASP
CREATE PROCEDURE sp_Search_SanPham_Theo_MaSp
@Masp INT
AS
BEGIN
	SELECT sp.*, ct.CPU,ct.RAM,ct.OCUNG,ct.MANHINH,ct.CARDMANHINH,ct.PORTCONNECT,ct.HDT,ct.AMTHANH,ct.DIAQUANG,ct.GIAOTIEPMANG,ct.WEBCAM,ct.PIN,ct.TRONGLUONG,ct.BAOHANH FROM dbo.SANPHAM AS sp 
	JOIN dbo.CTSP AS ct
	ON sp.MASP = @Masp AND ct.MASP=@Masp
END
GO



-- SEARCH THONG TIN TAI KHOAN NHAN VIEN KHI LOGIN
CREATE PROCEDURE sp_Search_ThongTinTaiKhoanNhanVien
@ID INT,
@PASS INT
AS
BEGIN
SELECT ct.MAQH,nv.HOTEN, pq.TENQH 
	FROM dbo.TAIKHOAN AS tk 
	JOIN dbo.CTPQ AS ct 
	ON tk.ID=@ID AND tk.Password=@PASS
	JOIN dbo.PHANQUYEN AS pq
	ON	ct.MAQH = pq.MAQH
	JOIN dbo.NHANVIEN AS nv
	ON nv.MANV=@ID AND ct.ID=@ID
END
GO

-- Hiển thị thông tin tài khoản nhân vien
CREATE PROCEDURE sp_Search_HienThiThongTinTaiKhoanNhanVien
AS
BEGIN
SELECT tk.ID, tk.Password, nv.HOTEN, ct.MAQH fROM NHANVIEN AS nv 
	join TAIKHOAN AS tk
	on tk.ID = nv.MANV
	join CTPQ AS ct
	on ct.ID = tk.ID
	join PHANQUYEN AS pq
	on pq.MAQH = ct.MAQH
END
GO

--  HIEN THI TAI KHOAN NHANVIEN THEO MAQH
CREATE PROCEDURE sp_SearchTaiKhoanNhanVienTheoMaQh
@MAQH NCHAR(50)
AS
BEGIN
SELECT tk.ID, tk.Password, nv.HOTEN, pq.TENQH, ct.MAQH fROM NHANVIEN AS nv 
	join TAIKHOAN AS tk
	on tk.ID = nv.MANV
	join CTPQ AS ct
	on ct.ID = tk.ID
	join PHANQUYEN AS pq
	on pq.MAQH = @MAQH AND ct.MAQH = @MAQH
END
GO


-- Tim Kiem Nhan Vien
CREATE PROCEDURE sp_TimKiemNhanVien
@Search nvarchar(250)
AS
BEGIN
    SELECT *FROM dbo.NHANVIEN WHERE MANV LIKE @Search 
		OR HOTEN LIKE @Search 
		OR GT LIKE @Search
		OR MAIL LIKE @Search
END
GO


-- Tim Kiem Khach Hang
ALTER PROCEDURE sp_TimKiemKhachHang
@Search nvarchar(250)
AS
BEGIN
    SELECT *FROM dbo.KHACHHANG WHERE MAKH LIKE @Search 
		OR TENKH LIKE @Search 
		OR GT LIKE @Search
		OR MAIL LIKE @Search
END
GO

-- Tim Kiem Nha Cung Cap

CREATE PROCEDURE sp_TimKiemNhaCungCap
@Search NVARCHAR(250)
AS
BEGIN
    SELECT *FROM dbo.NHACC WHERE MACC LIKE @Search
		OR TENCC LIKE @Search
		OR SDT LIKE @Search
END
GO

-- Tim Kiem Nha San Xuat
CREATE PROCEDURE sp_TimKiemNhaSanXuat
@Search NVARCHAR(250)
AS
BEGIN
    SELECT *FROM  dbo.NHASX WHERE MASX LIKE @Search
		OR TENSX LIKE @Search
		OR QUOCGIA LIKE @Search
END
GO

-- Tim Kiem Loai San PHam
CREATE PROCEDURE sp_TimKiemLoaiSanPham
@Search NVARCHAR(250)
AS
BEGIN
    SELECT *FROM dbo.LOAISP WHERE MALOAI LIKE @Search
		OR TENLOAI LIKE @Search
		OR DVT LIKE @Search
END
GO

-- Tim Kiem San Pham
CREATE PROCEDURE sp_TimKiemSanPham
@Search NVARCHAR(250)
AS
BEGIN
    SELECT ct.*, sp.TENSP,sp.MASX,sp.MALOAI,sp.GIATHANH 
		FROM dbo.SANPHAM AS sp
		JOIN dbo.CTSP AS ct
		ON (ct.MASP LIKE @Search AND sp.MASP LIKE @Search) 
		OR (sp.MASX LIKE @Search AND ct.MASP = sp.MASP) 
		OR (sp.MALOAI LIKE @Search AND ct.MASP = sp.MASP)
		OR (sp.TENSP LIKE @Search AND ct.MASP = sp.MASP)
		--JOIN dbo.LOAISP AS lsp
		--ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI = @Search
		--JOIN dbo.NHASX AS nsx
		--ON nsx.MASX = sp.MASX AND nsx.TENSX = @Search

END
GO


-- Tim Kien Don Dat Hang
CREATE PROCEDURE sp_TimKiemDonDatHang
@Search NVARCHAR(250)
AS
BEGIN
    SELECT dh.*, ct.MASP, ct.SLDH FROM dbo.DONDH AS dh
		JOIN dbo.CTDH AS ct
		ON (ct.MADH LIKE @Search AND dh.MADH LIKE @Search)
		OR (dh.MANV LIKE @Search AND ct.MADH = dh.MADH)
		OR (dh.MACC LIKE @Search AND ct.MADH = dh.MADH)
		OR (ct.SLDH LIKE @Search AND ct.MADH = dh.MADH)
		OR (ct.MASP LIKE @Search AND ct.MADH = dh.MADH)
END
GO

-- Tim Kien Phieu Nhap
CREATE PROCEDURE sp_TimKiemPhieuNhap
@Search NVARCHAR(250)
AS
BEGIN
    SELECT pn.*, ct.MASP,ct.SLN,ct.DONGIA FROM dbo.PHIEUNHAP AS pn
	JOIN dbo.CTPN AS ct
		ON (pn.MAPN = @Search AND ct.MAPN LIKE @Search)
		OR (pn.MANV LIKE @Search AND ct.MAPN = pn.MAPN)
		OR (pn.MADH LIKE @Search AND ct.MAPN = pn.MAPN)
		OR (ct.MASP LIKE @Search AND ct.MAPN = pn.MAPN)
END
GO


-- Tim Kiem Phieu Xuat
CREATE PROCEDURE sp_TimKiemPhieuXuat
@Search NVARCHAR(250)
AS
BEGIN
    SELECT px.*, ct.MASP,ct.SLX,ct.PHANTRAM,ct.THANHTIEN FROM dbo.PHIEUXUAT AS px
		JOIN dbo.CTPX AS ct
		ON (px.MAPX LIKE @Search AND px.MAPX = ct.MAPX)
		OR (px.MANV LIKE @Search AND ct.MAPX = px.MAPX)
		OR (px.MAKH LIKE @Search AND ct.MAPX = px.MAPX)
		OR (ct.MASP LIKE @Search AND ct.MAPX = px.MAPX)
END
GO



-- |========================================> THONG KE <====================================================|

-- Thong ke don hang theo ngay
CREATE PROCEDURE sp_ThongKeDonDatHangTheoNgayThang
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
      SELECT sp.MASP,sp.TENSP, lsp.TENLOAI,nsx.TENSX,SUM(ctdh.SLDH) AS SLDH FROM dbo.CTDH AS ctdh
		JOIN  dbo.SANPHAM AS sp
		ON sp.MASP = ctdh.MASP
		JOIN dbo.LOAISP AS lsp
		ON lsp.MALOAI = sp.MALOAI
		JOIN dbo.NHASX AS nsx
		ON nsx.MASX = sp.MASX
		JOIN dbo.DONDH AS dh
		ON dh.MADH = ctdh.MADH AND dh.NGDH BETWEEN @DateTimesOne AND @DateTimesTwo
		GROUP BY sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX
END
GO
--    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX,ctdh.SLDH FROM dbo.DONDH AS dh
--	JOIN dbo.CTDH AS ctdh
--	ON ctdh.MADH = dh.MADH AND dh.NGDH BETWEEN @DateTimesOne AND @DateTimesTwo
--	JOIN  dbo.SANPHAM AS sp
--	ON sp.MASP = ctdh.MASP
--	JOIN dbo.LOAISP AS lsp
--	ON lsp.MALOAI = sp.MALOAI
--	JOIN dbo.NHASX AS nsx
--	ON nsx.MASX = sp.MASX
--	GROUP BY sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX,ctdh.SLDH
--	GO
    
--    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX,ctdh.SLDH FROM dbo.CTDH AS ctdh
--		JOIN  dbo.SANPHAM AS sp
--		ON sp.MASP = ctdh.MASP
--		JOIN dbo.LOAISP AS lsp
--		ON lsp.MALOAI = sp.MALOAI
--		JOIN dbo.NHASX AS nsx
--		ON nsx.MASX = sp.MASX
--		GROUP BY sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX,ctdh.SLDH
--	GO
    
--      SELECT sp.MASP,sp.TENSP, lsp.TENLOAI,nsx.TENSX FROM dbo.CTDH AS ctdh
--		JOIN  dbo.SANPHAM AS sp
--		ON sp.MASP = ctdh.MASP
--		JOIN dbo.LOAISP AS lsp
--		ON lsp.MALOAI = sp.MALOAI
--		JOIN dbo.NHASX AS nsx
--		ON nsx.MASX = sp.MASX
--		JOIN dbo.DONDH AS dh
--		ON dh.MADH = ctdh.MADH AND dh.NGDH BETWEEN '20180101' AND '20180901'
--		GROUP BY sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX
--GO


-- Thong Ke Don Hang
 CREATE PROCEDURE sp_ThongKeDonDatHang
 AS
 BEGIN
      SELECT sp.MASP,sp.TENSP, lsp.TENLOAI,nsx.TENSX,SUM(ctdh.SLDH) AS SLDH FROM dbo.CTDH AS ctdh
		JOIN  dbo.SANPHAM AS sp
		ON sp.MASP = ctdh.MASP
		JOIN dbo.LOAISP AS lsp
		ON lsp.MALOAI = sp.MALOAI
		JOIN dbo.NHASX AS nsx
		ON nsx.MASX = sp.MASX
		JOIN dbo.DONDH AS dh
		ON dh.MADH = ctdh.MADH
		GROUP BY sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX
 END
 GO


 -- Thon Ke Tong So Don Dat Hang Theo Ma San Pham
CREATE PROCEDURE sp_ThongKeTongSoDoDhTheoMaSp
@Masp int
AS
BEGIN
	    SELECT SUM(ctdh.SLDH) AS SLDH FROM dbo.CTDH AS ctdh
		JOIN  dbo.SANPHAM AS sp
		ON sp.MASP = @Masp AND ctdh.MASP = @Masp
		JOIN dbo.LOAISP AS lsp
		ON lsp.MALOAI = sp.MALOAI
		JOIN dbo.NHASX AS nsx
		ON nsx.MASX = sp.MASX
		JOIN dbo.DONDH AS dh
		ON dh.MADH = ctdh.MADH
		GROUP BY sp.MASP
END
GO


-- Thong Ke Don Dat Hang Theo Ten Loai San Pham
CREATE PROCEDURE sp_ThongKeDonHangTheoTenLoai
@TenLoai NVARCHAR(50)
AS
BEGIN
     SELECT sp.MASP,sp.TENSP, lsp.TENLOAI,nsx.TENSX,SUM(ctdh.SLDH) AS SLDH FROM dbo.CTDH AS ctdh
		JOIN  dbo.SANPHAM AS sp
		ON sp.MASP = ctdh.MASP
		JOIN dbo.LOAISP AS lsp
		ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI = @TenLoai
		JOIN dbo.NHASX AS nsx
		ON nsx.MASX = sp.MASX 
		JOIN dbo.DONDH AS dh
		ON dh.MADH = ctdh.MADH
		GROUP BY sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX
END
GO

-- Tinh So  Lượng Đặt Hàng Theo Loại Sản Phẩm
CREATE PROCEDURE sp_TinhTongSlDonDhTheoLoaiSp
@TenLoai NVARCHAR(50)
AS
BEGIN
     SELECT SUM(ctdh.SLDH) AS SLDH FROM dbo.CTDH AS ctdh
		JOIN  dbo.SANPHAM AS sp
		ON sp.MASP = ctdh.MASP
		JOIN dbo.LOAISP AS lsp
		ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI = @TenLoai
		JOIN dbo.NHASX AS nsx
		ON nsx.MASX = sp.MASX 
		JOIN dbo.DONDH AS dh
		ON dh.MADH = ctdh.MADH
END
GO

-- Tinh So Lượng Đặt Hàng Theo Loại Sản Phẩm
CREATE PROCEDURE sp_TinhTongSlDonDhTheoNhaSx
@NhaSx NVARCHAR(50)
AS
BEGIN
     SELECT SUM(ctdh.SLDH) AS SLDH FROM dbo.CTDH AS ctdh
		JOIN  dbo.SANPHAM AS sp
		ON sp.MASP = ctdh.MASP
		JOIN dbo.LOAISP AS lsp
		ON lsp.MALOAI = sp.MALOAI 
		JOIN dbo.NHASX AS nsx
		ON nsx.MASX = sp.MASX AND nsx.TENSX = @NhaSx
		JOIN dbo.DONDH AS dh
		ON dh.MADH = ctdh.MADH
END
GO

-- Tinh So Lượng Đặt Hàng Theo Ngay Dat Hang
CREATE PROCEDURE sp_TinhTongSlDonDhTheoNgayDatHang
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
      SELECT SUM(ctdh.SLDH) AS SLDH FROM dbo.CTDH AS ctdh
		JOIN  dbo.SANPHAM AS sp
		ON sp.MASP = ctdh.MASP
		JOIN dbo.LOAISP AS lsp
		ON lsp.MALOAI = sp.MALOAI
		JOIN dbo.NHASX AS nsx
		ON nsx.MASX = sp.MASX
		JOIN dbo.DONDH AS dh
		ON dh.MADH = ctdh.MADH AND dh.NGDH BETWEEN @DateTimesOne AND @DateTimesTwo

END
GO

-- Thon ke Don Dat Hang Theo Ten Nha San Xuat
CREATE PROCEDURE sp_ThongKeDonHangTheoNhaSx
@TenSx NVARCHAR(50)
AS
BEGIN
         SELECT sp.MASP,sp.TENSP, lsp.TENLOAI,nsx.TENSX,SUM(ctdh.SLDH) AS SLDH FROM dbo.CTDH AS ctdh
		JOIN  dbo.SANPHAM AS sp
		ON sp.MASP = ctdh.MASP
		JOIN dbo.LOAISP AS lsp
		ON lsp.MALOAI = sp.MALOAI
		JOIN dbo.NHASX AS nsx
		ON nsx.MASX = sp.MASX AND nsx.TENSX = @TenSx
		JOIN dbo.DONDH AS dh
		ON dh.MADH = ctdh.MADH
		GROUP BY sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX
END
GO

-- Thong Ke Phieu Nhap

CREATE PROCEDURE sp_ThongKePhieuNhap
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX,dbo.Fn_SlDh(dh.MADH) AS SLD,dbo.Fn_TongNhap(dh.MADH) AS SLN,dbo.Fn_TongConNhap(dh.MADH) SLCN,ctpn.DONGIA,dbo.Fn_ThanhTienNhap(dh.MADH) AS ThanhTien FROM dbo.PHIEUNHAP AS pn
	JOIN dbo.CTPN AS ctpn
	ON ctpn.MAPN = pn.MAPN
	JOIN dbo.DONDH AS dh
	ON dh.MADH = pn.MADH
	JOIN dbo.CTDH AS ctdh
	ON ctdh.MADH = dh.MADH
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctdh.MASP AND sp.MASP = ctpn.MASP
	JOIN dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX
END
GO


-- Thong Ke Phieu Nhap Theo Ten Cung Cap
CREATE PROCEDURE sp_ThongKePhieuNhapTheoNhaCungCap
@TenCc NVARCHAR(MAX)
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX,dbo.Fn_SlDh(dh.MADH) AS SLD,dbo.Fn_TongNhap(dh.MADH) AS SLN,dbo.Fn_TongConNhap(dh.MADH) SLCN,ctpn.DONGIA,dbo.Fn_ThanhTienNhap(dh.MADH) AS ThanhTien FROM dbo.PHIEUNHAP AS pn
	JOIN dbo.CTPN AS ctpn
	ON ctpn.MAPN = pn.MAPN
	JOIN dbo.DONDH AS dh
	ON dh.MADH = pn.MADH
	JOIN dbo.CTDH AS ctdh
	ON ctdh.MADH = dh.MADH
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctdh.MASP AND sp.MASP = ctpn.MASP
	JOIN dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX
	JOIN  dbo.NHACC AS ncc
	ON ncc.MACC = dh.MACC AND ncc.TENCC = @TenCc
END
GO

-- Thong Ke Phieu Nhap Theo Ten Cung Cap
CREATE PROCEDURE sp_ThongKePhieuNhapTheoLoaiSp
@LoaiSp NVARCHAR(MAX)
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX,dbo.Fn_SlDh(dh.MADH) AS SLD,dbo.Fn_TongNhap(dh.MADH) AS SLN,dbo.Fn_TongConNhap(dh.MADH) SLCN,ctpn.DONGIA,dbo.Fn_ThanhTienNhap(dh.MADH) AS ThanhTien FROM dbo.PHIEUNHAP AS pn
	JOIN dbo.CTPN AS ctpn
	ON ctpn.MAPN = pn.MAPN
	JOIN dbo.DONDH AS dh
	ON dh.MADH = pn.MADH
	JOIN dbo.CTDH AS ctdh
	ON ctdh.MADH = dh.MADH
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctdh.MASP AND sp.MASP = ctpn.MASP
	JOIN dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI = @LoaiSp
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX
END
GO


-- Thong Ke Phieu Nhap Theo Ngay Thang
CREATE PROCEDURE sp_ThongKePhieuNhapTheoNgayThang
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI,nsx.TENSX,dbo.Fn_SlDh(dh.MADH) AS SLD,dbo.Fn_TongNhap(dh.MADH) AS SLN,dbo.Fn_TongConNhap(dh.MADH) SLCN,ctpn.DONGIA,dbo.Fn_ThanhTienNhap(dh.MADH) AS ThanhTien FROM dbo.PHIEUNHAP AS pn
	JOIN dbo.CTPN AS ctpn
	ON ctpn.MAPN = pn.MAPN AND pn.NGAYNHAP BETWEEN @DateTimesOne AND @DateTimesTwo
	JOIN dbo.DONDH AS dh
	ON dh.MADH = pn.MADH
	JOIN dbo.CTDH AS ctdh
	ON ctdh.MADH = dh.MADH
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctdh.MASP AND sp.MASP = ctpn.MASP
	JOIN dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX
END
GO


-- Tinh Tong So Phieu Nhap Theo Ngay Thang
CREATE PROCEDURE sp_TinhTongSoPhieuNhapTheoNgayThang
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
    SELECT dbo.Fn_TinhTongSoPhieuNhapTheoNgayThangChoPhieuNhap(@DateTimesOne,@DateTimesTwo)
END
GO




-- Tinh Tong So Phieu Nhap Theo Ngay Thang
CREATE PROCEDURE sp_TinhTongSoPhieuNhapTheoLoaiSp
@LoaiSp NVARCHAR(100)
AS
BEGIN
    SELECT dbo.Fn_TinhTongSoPhieuNhapTheoLoaiSp(@LoaiSp)
END
GO

-- Tinh Tong So Phieu Nhap Theo Nha Cung Cap
CREATE PROCEDURE sp_TinhTongSoPhieuNhapTheoNhaCungCap
@NhaCc NVARCHAR(100)
AS
BEGIN
    SELECT dbo.Fn_TinhTongSoPhieuNhapTheoNhaCungCap(@NhaCc)
END
GO


-- Tinh Tong So Luong Con Nhap Cho Phieu Nhap Theo Nha Cung Cap
CREATE PROCEDURE sp_TinhTongSoPhieuConNhapTheoNhaCungCap
@NhaCc NVARCHAR(100)
AS
BEGIN
   SELECT dbo.Fn_TinhTongSoPhieuConNhapTheoNhaCungCap(@NhaCc)
END
GO


-- Tinh Tong So Luong Con Nhap Cho Phieu Nhap Theo Nha Cung Cap
CREATE PROCEDURE sp_TinhTongSoPhieuConNhapTheoLoaiSp
@LoaiSp NVARCHAR(100)
AS
BEGIN
	SELECT dbo.Fn_TinhTongSoPhieuConNhapTheoLoaiSp(@LoaiSp)
END
GO


-- Tinh Tong So Luong Con Nhap Cho Phieu Nhap Theo Ngay Nhap
ALTER PROCEDURE sp_TinhTongSoPhieuConNhapTheoNgayNhap
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
    SELECT dbo.Fn_TinhTongSoPhieuConNhapTheoNgayNhap(@DateTimesOne,@DateTimesTwo)

END
GO


-- Tinh Tong Thanh Tien Phieu Nhap Theo Ngay Nhap
CREATE PROCEDURE sp_TinhTongThanhTienPhieuNhapTheoNgayNhap
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
    SELECT dbo.Fn_TinhTongThanhTienPhieuNhapTheoNgayNhap(@DateTimesOne,@DateTimesTwo)

END
GO


-- Tinh Tong Tong Thanh Tien Phieu Nhap Theo Loai San Pham
CREATE PROCEDURE sp_TinhTongThanhTienPhieuNhapTheoLoaiSp
@LoaiSp NVARCHAR(100)
AS
BEGIN
    SELECT dbo.Fn_TinhTongThanhTienPhieuNhapTheoLoaiSp(@LoaiSp)

END
GO

-- Tinh Tong Tong Thanh Tien Phieu Nhap Theo Nha Cung Cap
CREATE PROCEDURE sp_TinhTongThanhTienPhieuNhapTheoNhaCc
@NhaCc NVARCHAR(100)
AS
BEGIN
	SELECT dbo.Fn_TinhTongThanhTienPhieuNhapTheoNhaCc(@NhaCc)
END
GO

-- Thong Ke Phieu Xuat
CREATE PROCEDURE sp_ThongKePhieuXuat
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI, nsx.TENSX,kh.TENKH,ctpx.SLX,sp.GIATHANH*ctpx.SLX AS TongTien,ctpx.PHANTRAM,ctpx.THANHTIEN FROM dbo.PHIEUXUAT AS px
	JOIN dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctpx.MASP
	JOIN  dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI
	JOIN  dbo.KHACHHANG AS kh
	ON kh.MAKH = px.MAKH
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX
END
GO



-- Thong Ke Phieu Xuat Theo Ngay Thang
CREATE PROCEDURE sp_ThongKePhieuXuatTtheoNgayThang
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI, nsx.TENSX,kh.TENKH,ctpx.SLX,sp.GIATHANH*ctpx.SLX AS TongTien,ctpx.PHANTRAM,ctpx.THANHTIEN FROM dbo.PHIEUXUAT AS px
	JOIN dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX AND px.NGAYXUAT BETWEEN @DateTimesOne AND @DateTimesTwo
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctpx.MASP
	JOIN  dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI
	JOIN  dbo.KHACHHANG AS kh
	ON kh.MAKH = px.MAKH
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX
END
GO

-- Thong Ke Phieu Xuat Theo Loai San Pham
CREATE PROCEDURE sp_ThongKePhieuXuatTtheoLoaiSp
@LoaiSp NVARCHAR(MAX)
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI, nsx.TENSX,kh.TENKH,ctpx.SLX,sp.GIATHANH*ctpx.SLX AS TongTien,ctpx.PHANTRAM,ctpx.THANHTIEN FROM dbo.PHIEUXUAT AS px
	JOIN dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctpx.MASP
	JOIN  dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI = @LoaiSp
	JOIN  dbo.KHACHHANG AS kh
	ON kh.MAKH = px.MAKH
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX
END
GO 

-- Thong Ke Phieu Xuat Theo Loai San Pham
CREATE PROCEDURE sp_ThongKePhieuXuatTtheoTenSp
@TenSp NVARCHAR(MAX)
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI, nsx.TENSX,kh.TENKH,ctpx.SLX,sp.GIATHANH*ctpx.SLX AS TongTien,ctpx.PHANTRAM,ctpx.THANHTIEN FROM dbo.PHIEUXUAT AS px
	JOIN dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX 
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctpx.MASP AND sp.TENSP = @TenSp
	JOIN  dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI
	JOIN  dbo.KHACHHANG AS kh
	ON kh.MAKH = px.MAKH
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX
END
GO 

-- Thong Ke Phieu Xuat Theo Nha San Xuat
CREATE PROCEDURE sp_ThongKePhieuXuatTtheoNhaSx
@NhaSx NVARCHAR(MAX)
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI, nsx.TENSX,kh.TENKH,ctpx.SLX,sp.GIATHANH*ctpx.SLX AS TongTien,ctpx.PHANTRAM,ctpx.THANHTIEN FROM dbo.PHIEUXUAT AS px
	JOIN dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctpx.MASP 
	JOIN  dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI
	JOIN  dbo.KHACHHANG AS kh
	ON kh.MAKH = px.MAKH
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX AND nsx.TENSX = @NhaSx
END
GO 


-- Tinh Tong SLX Theo Ngay Xuat
CREATE PROCEDURE sp_TinhTongSlxPhieuXuatTheoNgayXuat
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
	SELECT dbo.Fn_TinhTongSlxPhieuXuatTheoNgayXuat(@DateTimesOne,@DateTimesTwo)
    
END
GO



-- TInh Tong Thanh Tien Theo Ngay
CREATE PROCEDURE sp_TinhTongThanhTienPhieuXuatTheoNgayXuat
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
    SELECT dbo.Fn_TinhTongThanhTienPhieuXuatTheoNgayXuat(@DateTimesOne, @DateTimesTwo)
END
GO


-- Tinh Tong SLX Theo Nha San Xuat
CREATE PROCEDURE sp_TinhTongSlxPhieuXuatTheoNhaSx
@NhaSx NVARCHAR(100)
AS
BEGIN
    SELECT dbo.Fn_TinhTongSlxPhieuXuatTheoNhaSanXuat(@NhaSx)
END
GO




-- Tinh Tong Thanh Tien Theo Nha San Xuat
CREATE PROCEDURE sp_TinhhTongThanhTienPHieuXuatTheoNhaSx
@NhaSx NVARCHAR(100)
AS
BEGIN
    SELECT dbo.Fn_TinhTongThanhTienPhieuXuatTheoNhaSx(@NhaSx)
END
GO


-- TInh Tong SLX Theo Loai San Pham
CREATE PROCEDURE sp_TinhTongSlxPHieuXuatTheoLoaiSp
@LoaiSp NVARCHAR(100)
AS
BEGIN
    SELECT dbo.Fn_TinhTongSlxPhieuXuatTheoLoaiSp(@LoaiSp)
END
GO



-- Tinh Tong Thang Tien Theo Loai San Pham
CREATE PROCEDURE sp_TinhTongThanhTienPHieuXuatTheoLoaiSp
@LoaiSp NVARCHAR(100)
AS
BEGIN
    SELECT dbo.Fn_TinhTongThanhTienPhieuXuatTheoLoaiSp(@LoaiSp)
END
GO



---- Thong Ke Phieu Xuat Theo Loai San Pham
--CREATE PROCEDURE sp_ThongKePhieuXuatTtheoLoaiSp
--@LoaiSp NVARCHAR(MAX)
--AS
--BEGIN
--    SELECT sp.MASP,sp.TENSP,lsp.TENLOAI, nsx.TENSX,kh.TENKH,ctpx.SLX,sp.GIATHANH*ctpx.SLX AS TongTien,ctpx.PHANTRAM,ctpx.THANHTIEN FROM dbo.PHIEUXUAT AS px
--	JOIN dbo.CTPX AS ctpx
--	ON ctpx.MAPX = px.MAPX 
--	JOIN dbo.SANPHAM AS sp
--	ON sp.MASP = ctpx.MASP
--	JOIN  dbo.LOAISP AS lsp
--	ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI =  @LoaiSp
--	JOIN  dbo.KHACHHANG AS kh
--	ON kh.MAKH = px.MAKH
--	JOIN  dbo.NHASX AS nsx
--	ON nsx.MASX = sp.MASX
--END
--GO 
-- Danh Sach Ton Kho
CREATE PROCEDURE sp_DanhSachTonKho
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,tk.TONGSLD,tk.TONGSLN, tk.TONGSLX, tk.TONGSLT FROM dbo.TONKHO AS tk 
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = tk.MASP
END
GO


-- Thong Ke Ton Kho Theo Ngay Thang
CREATE PROCEDURE sp_ThongKeTonKhoTheoNgayThang
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,tk.TONGSLD,tk.TONGSLN, tk.TONGSLX, tk.TONGSLT FROM dbo.TONKHO AS tk 
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = tk.MASP AND tk.MONTH_YEAR BETWEEN @DateTimesOne AND @DateTimesTwo
END
GO


-- Thong Ke Ton Kho Theo Loai Sản Phẩm
CREATE PROCEDURE sp_ThongKeTonKhoTheoLoaiSp
@LoaiSp NVARCHAR(100)
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,tk.TONGSLD,tk.TONGSLN, tk.TONGSLX, tk.TONGSLT FROM dbo.TONKHO AS tk 
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = tk.MASP
	JOIN dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI = @LoaiSp
END
GO


-- THong Ke Ton Kho Theo  Nha San Xuat
CREATE PROCEDURE sp_ThongKeTonKhoTheoNhaSx
@NhaSx NVARCHAR(100)
AS
BEGIN
    SELECT sp.MASP,sp.TENSP,tk.TONGSLD,tk.TONGSLN, tk.TONGSLX, tk.TONGSLT FROM dbo.TONKHO AS tk 
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = tk.MASP
	JOIN dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX AND nsx.TENSX = @NhaSx
END
GO

sp_ThongKeTonKhoTheoNhaSx 'DELL'
-- Thong Ke Tinh So Luong Ton Kho Theo Nha San Xuat
CREATE PROCEDURE sp_TinhTongSltChoTonKho
@NhaSx NVARCHAR(100)
AS
BEGIN
	SELECT dbo.Fn_TinhTongSltTonKho(@NhaSx)
END
GO

sp_TinhTongSltChoTonKho 'DELL'

-- Thong Ke Tinh So Luong Ton Kho Theo Loai San Pham
CREATE PROCEDURE sp_TinhTongSltChoTonKhoTheoLoaiSp
@LoaiSp NVARCHAR(100)
AS
BEGIN
  SELECT SUM(tk.TONGSLT) FROM dbo.TONKHO AS tk 
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = tk.MASP
	JOIN dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI = @LoaiSp
END
GO


-- Thong Ke Tinh So Luong Ton Kho Theo Loai NGAY THANG
CREATE PROCEDURE sp_TinhTongSltChoTonKhoTheoNgayThang
@DateTimesOne DATETIME,
@DateTimesTwo DATETIME
AS
BEGIN
    SELECT dbo.Fn_TinhTongSltChoTonKhoTheoNgayThang(@DateTimesOne,@DateTimesTwo)
	
END
GO




-- |=======================================> TRIGGER CHECK <========================================|

-- TRIGGER TO PHIEUXUAT
--ALTER TRIGGER tg_Insert_PHIEUXUAT 
--ON PHIEUXUAT
--FOR INSERT
--AS
--	-- Khai bao bien
--	DECLARE @sodh INT,@ngayxuat DATETIME
--	-- Nhap du lieu
--	SELECT @sodh=MADH, @ngayxuat=NGAYXUAT FROM INSERTED
--	PRINT 'so don hang la: '+CAST(@sodh AS CHAR(1000))
--	-- Kiem tra 1
--	IF NOT EXISTS(SELECT *FROM dbo.DONDH WHERE MADH=@sodh)
--	BEGIN
--		RAISERROR('SO DH sai',16,1)
--		ROLLBACK TRAN
--		RETURN
--	END
--	-- Kiem tra 2
--	DECLARE @ngaydh DATETIME
--	SELECT @ngaydh=NGDH FROM dbo.DONDH WHERE MADH=@sodh
--	IF @ngayxuat < @ngaydh
--	BEGIN 
--		RAISERROR ('Ngay Xuat Hang Phai nho hon ngay DH',16,1)
--		ROLLBACK TRAN
--		RETURN
--	END
    
--GO



-- TRIGGER TO TABLE CTPX
CREATE TRIGGER tg_TINHTHANHTIEN_TO_TABLE_CTPX
ON CTPX
FOR INSERT,UPDATE
AS
	DECLARE @MAPX INT, @MASP INT, @SLX INT, @PHANTRAM REAL
	SELECT @MAPX=MAPX, @MASP=MASP,@SLX=SLX,@PHANTRAM=PHANTRAM FROM INSERTED

	IF NOT EXISTS(SELECT *FROM CTPX WHERE MAPX=@MAPX)
	BEGIN
		RAISERROR ('PHIEU XUAT DA TON TAI MAPX',16,1)
		ROLLBACK TRAN
		RETURN
	END

	DECLARE @TONG MONEY
	SELECT @TONG=GIATHANH FROM dbo.SANPHAM WHERE MASP=@MASP
	UPDATE dbo.CTPX SET THANHTIEN=((@SLX*@TONG)*(100-@PHANTRAM)/(100)) WHERE MAPX=@MAPX

GO




---- TRIGGER CAP SO LUONG XUAT CHO BANG TON KHO
--ALTER TRIGGER tg_TinhTongSoLuongXuatChoTonKho
--ON dbo.CTPX
--FOR DELETE
--AS
--	DECLARE @MAPX INT, @MASP INT, @SLX INT
--	SELECT @MAPX = MAPX, @MASP = MASP, @SLX = SLX FROM Deleted

--	IF NOT EXISTS(SELECT *FROM dbo.CTPX WHERE MAPX=@MAPX)
--	BEGIN
--	    RAISERROR ('PHIEU XUAT KHONG TON TAI',16,1)
--		ROLLBACK TRAN
--		RETURN
--	END
--	SELECT @SLX = SLX FROM dbo.CTPX WHERE MASP = @MASP
--	UPDATE dbo.TONKHO SET TONGSLX = @SLX WHERE MASP = @MASP
--GO

--SELECT *FROM dbo.CTPX
--SELECT *FROM dbo.TONKHO WHERE MASP = 16160002

--UPDATE dbo.TONKHO SET TONGSLX = 2 WHERE MASP = 16160002

--DELETE dbo.CTPX WHERE MAPX = 19190027

--{=====================================> CREATE FUNCTION <==============================================}---->>

--1.1 Tao Function Tinh Tong Nhapp Hang Theo Ngay Nhap
CREATE FUNCTION Fn_TongNhapThang(@NgayNhap datetime, @MaSp int)
RETURNS INT
BEGIN
    -- Khai bao bien
	DECLARE @kq INT
	-- Xu ly
	SELECT @kq = SUM(a.SLN)
	FROM dbo.CTPN AS a INNER JOIN dbo.PHIEUNHAP AS b 
	ON b.MAPN = a.MAPN
	WHERE a.MASP=@MaSp AND b.NGAYNHAP = @NgayNhap
	-- Ham traa ve ket qua
	RETURN ISNULL(@kq,0)
END
GO

--1.2 Thuc Hien
--DECLARE @tong INT
--SET @tong = dbo.Fn_TongNhapThang ('20180514','16160002')
--PRINT @tong


--2.1 Tao Function Tinh Tong Xuat Hang Theo Ngay Nhap
CREATE FUNCTION Fn_TongXuatThang(@NgayXuat datetime, @MaSp int)
RETURNS INT
BEGIN
    -- Khai bao bien
	DECLARE @kq INT
	-- Xu ly
	SELECT @kq = SUM(a.SLX)
	FROM dbo.CTPX AS a INNER JOIN dbo.PHIEUXUAT AS b 
	ON b.MAPX = a.MAPX
	WHERE a.MASP=@MaSp AND b.NGAYXUAT = @NgayXuat
	-- Ham traa ve ket qua
	RETURN ISNULL(@kq,0)
END
GO

-- 2.2 Thuc Hien
DECLARE @tong INT
SET @tong = dbo.Fn_TongXuatThang('20180507','16160002')
PRINT @tong


-- 3.1 Tao Function Tinh Tong So Luong Dat Hang
CREATE FUNCTION Fn_SlDh(@MaDh int)
RETURNS int
BEGIN
    DECLARE @kq INT
	SELECT @kq = SLDH
	FROM dbo.CTDH
	WHERE MADH=@MaDh

	RETURN ISNULL(@kq,0)
END
GO

-- 3.2 Thuc Hien
--DECLARE @tong INT
--SET @tong = dbo.Fn_SlDh(17171004)
--PRINT @tong


-- 4.1 Tao Function Tinh Tong Nhap
ALTER FUNCTION Fn_TongNhap(@MaPn int)
RETURNS INT
BEGIN
    DECLARE @kq INT
	SELECT @kq = SLN
	FROM dbo.CTPN AS ct
	JOIN dbo.PHIEUNHAP AS pn
	ON pn.MAPN = ct.MAPN AND pn.MADH = @MaPn

	RETURN ISNULL(@kq,0)
END
GO


-- 4.2 Thuc Hien
--DECLARE @kq INT
--SET @kq = dbo.Fn_TongNhap(17171004)
--PRINT @kq

-- 5.1 Tao Function Tinh Tong So Luong San Pham Con Phai Nhap
CREATE FUNCTION Fn_TongConNhap(@MaDh int)
RETURNS int
BEGIN
    DECLARE @kq  INT
	SET @kq = dbo.Fn_SlDh(@MaDh) - dbo.Fn_TongNhap(@MaDh)
	RETURN ISNULL(@kq,0) 
END
GO

-- Tính Tống Số Lượng Nhập Cho PHiếu Nhập Theo Thời Gian
CREATE FUNCTION Hello(@DateTimesOne DATETIME,@DateTimesTwo DATETIME)
RETURNS INT
BEGIN
	DECLARE @kq INT 
    SELECT @kq = SUM(ctpn.SLN) FROM dbo.PHIEUNHAP AS pn
	JOIN dbo.CTPN AS ctpn
	ON ctpn.MAPN = pn.MAPN AND pn.NGAYNHAP BETWEEN @DateTimesOne AND @DateTimesTwo
	JOIN dbo.DONDH AS dh
	ON dh.MADH = pn.MADH
	JOIN dbo.CTDH AS ctdh
	ON ctdh.MADH = dh.MADH
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctdh.MASP AND sp.MASP = ctpn.MASP
	JOIN dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI
	JOIN  dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX

	RETURN ISNULL(@kq,0)
END
GO


-- 6.1 Tao Function Tinh Thanh Tien Phieu Nhap
CREATE FUNCTION Fn_ThanhTienNhap(@MaDh int)
RETURNS MONEY
BEGIN
    DECLARE @kq MONEY
	SELECT @kq = dbo.Fn_TongNhap(@MaDh)*ctpn.DONGIA
	FROM dbo.PHIEUNHAP AS pn
	JOIN dbo.CTPN AS ctpn
	ON ctpn.MAPN = pn.MAPN AND pn.MADH = @MaDh
	RETURN ISNULL(@kq,0)
END
GO

-- 6.2 Thuc Hien
--DECLARE @tong INT
--SET @tong = dbo.Fn_ThanhTienNhap(17170001)
--PRINT @tong
--GO

-- 7.1 Tao Function Tinh Tong Xuat
CREATE FUNCTION Fn_TongXuat(@MaPx INT)
RETURNS INT
BEGIN
    DECLARE @kq INT
	SELECT @kq = SLX FROM dbo.CTPX AS ct
	JOIN dbo.PHIEUXUAT AS px
	ON px.MAPX = @MaPx AND ct.MAPX = @MaPx
	
	RETURN ISNULL(@kq,0) 
END
GO


-- 7.2 Thuc Hien
--DECLARE @tong INT 
--SET @tong = dbo.Fn_TongXuat(19190027)
--PRINT @tong


CREATE FUNCTION Fn_TinhTongSltTonKho(@TenSx NVARCHAR(100))
RETURNS int
AS
BEGIN
  DECLARE @KQ INT
  SELECT @KQ = SUM(tk.TONGSLT) FROM dbo.TONKHO AS tk 
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = tk.MASP
	JOIN dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX AND nsx.TENSX = @TenSx

	RETURN ISNULL(@KQ,0)    
END

GO

-- 8.2 

-- 9.1 CREATE FUNTION TINH TONG SO LUONG TON KHO THEO NGAY THANG
CREATE FUNCTION Fn_TinhTongSltChoTonKhoTheoNgayThang(@DateTimesOne DATETIME, @DateTimesTwo DATETIME)
RETURNS INT
AS
BEGIN
	DECLARE @KQ INT
    SELECT @KQ = SUM(TONGSLT) FROM dbo.TONKHO WHERE MONTH_YEAR BETWEEN @DateTimesOne AND @DateTimesTwo
	RETURN ISNULL(@KQ,0)
END
GO


-- 10.1 Tinh Tong So Luong Xuat Cho Phieu Xuat Theo LLoai San Pham
CREATE FUNCTION Fn_TinhTongSlxPhieuXuatTheoLoaiSp(@LoaiSp NVARCHAR(100))
RETURNS INT
AS
BEGIN
    DECLARE @kq1 INT
	SELECT @kq1 = SUM(ctpx.SLX) FROM dbo.PHIEUXUAT AS px
	JOIN  dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctpx.MASP
	JOIN dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI = @LoaiSp
	RETURN ISNULL(@kq1,0)
END
GO


-- 11.1 Tinh Tong Thanh Tien Phieu Xuat Theo Loai San Pham
CREATE FUNCTION Fn_TinhTongThanhTienPhieuXuatTheoLoaiSp(@LoaiSp NVARCHAR(100))
RETURNS MONEY
AS
BEGIN
    DECLARE @kq1 MONEY
	SELECT @kq1 = SUM(ctpx.THANHTIEN) FROM dbo.PHIEUXUAT AS px
	JOIN  dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctpx.MASP
	JOIN dbo.LOAISP AS lsp
	ON lsp.MALOAI = sp.MALOAI AND lsp.TENLOAI = @LoaiSp
	RETURN ISNULL(@kq1,0)

END


-- 12.1 Tinh Tong So Luong Xuat Cho Phieu Xuat Theo Nha San Xuat
CREATE FUNCTION Fn_TinhTongSlxPhieuXuatTheoNhaSanXuat(@NhaSx NVARCHAR(100))
RETURNS INT
AS
BEGIN
    DECLARE @kq1 INT
	SELECT @kq1 = SUM(ctpx.SLX) FROM dbo.PHIEUXUAT AS px
	JOIN  dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctpx.MASP
	JOIN dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX AND nsx.TENSX = @NhaSx
	RETURN ISNULL(@kq1,0)
END
GO

-- 13.1 Tinh Tong Thanh Tien Phieu Xuat Theo Nha San Xuat
CREATE FUNCTION Fn_TinhTongThanhTienPhieuXuatTheoNhaSx(@NhaSx NVARCHAR(100))
RETURNS MONEY
AS
BEGIN
    DECLARE @kq1 MONEY
	SELECT @kq1 = SUM(ctpx.THANHTIEN) FROM dbo.PHIEUXUAT AS px
	JOIN  dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX
	JOIN dbo.SANPHAM AS sp
	ON sp.MASP = ctpx.MASP
	JOIN dbo.NHASX AS nsx
	ON nsx.MASX = sp.MASX AND nsx.TENSX = @NhaSx
	RETURN ISNULL(@kq1,0)

END


-- 14.1 Tinh Tong So Luong Xuat Cho Phieu Xuat Theo Ngay Xuat
CREATE FUNCTION Fn_TinhTongSlxPhieuXuatTheoNgayXuat(@DateTimesOne DATETIME,@DateTimesTwo DATETIME)
RETURNS INT
AS
BEGIN
    DECLARE @kq1 INT
	SELECT @kq1 = SUM(ctpx.SLX) FROM dbo.PHIEUXUAT AS px
	JOIN  dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX AND px.NGAYXUAT BETWEEN @DateTimesOne AND @DateTimesTwo
	RETURN ISNULL(@kq1,0)
END
GO



--14.1 Tinh Tong Thanh Tien Phieu Xuat Theo Ngay Xuat
CREATE FUNCTION Fn_TinhTongThanhTienPhieuXuatTheoNgayXuat(@DateTimesOne DATETIME,@DateTimesTwo DATETIME)
RETURNS MONEY
AS
BEGIN
    DECLARE @kq1 MONEY
	SELECT @kq1 = SUM(ctpx.THANHTIEN) FROM dbo.PHIEUXUAT AS px
	JOIN  dbo.CTPX AS ctpx
	ON ctpx.MAPX = px.MAPX AND px.NGAYXUAT BETWEEN @DateTimesOne AND @DateTimesTwo
	RETURN ISNULL(@kq1,0)

END
GO


---- 9.2 THUC HIEN
--DECLARE @KQ INT 
--SET @KQ = dbo.Fn_TinhTongSltChoTonKhoTheoNgayThang('20180501','20180501')
--PRINT @KQ

--{=====================================================> <=====================================================}====>>








--CREATE TRIGGER tg_Update_TonKho
--ON dbo.TONKHO
--FOR UPDATE
--AS
--	DECLARE @MASP INT, @SLX INT
--	SELECT @MASP = MASP, @SLX = Inserted.TONGSLX FROM Inserted

--	IF NOT EXISTS(SELECT *FROM dbo.TONKHO WHERE MASP=@MASP)
--	BEGIN
--	    RAISERROR ('KHONG TON TAI SAN PHAM CAN UPDATE KHO',16,1)
--		ROLLBACK TRAN
--		RETURN
--	END

--	UPDATE dbo.TONKHO SET TONGSLT=((TONGSLD+TONGSLN)-@SLX) WHERE MASP=@MASP
--GO


--	SELECT sp.GIATHANH FROM dbo.SANPHAM AS sp 
--		JOIN dbo.CTDH AS ctdh 
--		ON ctdh.MASP = sp.MASP 
--		JOIN dbo.DONDH AS dh
--		ON dh.MADH = 17170001 and ctdh.MADH = 17170001
--		JOIN dbo.CTPX AS ctpx 
--		ON ctpx.MADH = ctdh.MADH

--	SELECT *FROM dbo.SANPHAM

--SELECT *FROM dbo.DONDH
--SELECT *FROM dbo.CTDH
--SELECT *FROM dbo.PHIEUXUAT
--SELECT *FROM dbo.CTPX
--SELECT *FROM dbo.KHACHHANG

--SELECT *FROM dbo.SANPHAM

--EXEC dbo.sp_Insert_PHIEUXUAT @MANV = 15150001,                         -- int
--                             @MAKH = 12120001,                         -- int
--                             @MASP = 16160001,                         -- int
--                             @SLX = 2,                          -- int
--                             --@DONGIA = NULL,                    -- money
--                             @NGAYXUAT = '2018-04-16 06:04:57', -- datetime
--                             @MADH = 17170006,                          -- int
--							 @PHANTRAM = 1


--SELECT *FROM dbo.CTDH

--SELECT *FROM dbo.CTPX

--SELECT *FROM dbo.PHIEUXUAT

--SELECT *FROM dbo.SANPHAM 




--SELECT SLDH, MASP FROM dbo.CTDH WHERE MADH=17170006


INSERT INTO dbo.CHUCNANG VALUES (N'DANHMUC',N'NHAN VIEN',0,0,0,0,0),
								(N'DANHMUC',N'KHACH HANG',0,0,0,0,0),
								(N'DANHMUC',N'NHA CUNG CAP',0,0,0,0,0),
								(N'DANHMUC',N'NHA SAN XUAT',0,0,0,0,0),
								(N'DANHMUC',N'LOAI SAN PHAM',0,0,0,0,0),
								(N'DANHMUC',N'SAN PHAM',0,0,0,0,0),
								(N'QUANLYBANHANG','DON DAT HANG',0,0,0,0,0),
								(N'QUANLYBANHANG','PHIEU NHAP HANG',0,0,0,0,0),
								(N'QUANLYBANHANG','PHIEU XUAT HANG',0,0,0,0,0),
								(N'QUANLYBANHANG','CHI TIET BAN HANG',0,0,0,0,0),
								(N'THONGKE','DON HANG',0,0,0,0,0),
								(N'THONGKE','NHAP HANG',0,0,0,0,0),
								(N'THONGKE','XUAT HANG',0,0,0,0,0),
								(N'THONGKE','TON KHO',0,0,0,0,0),
								(N'THONGKE','BIEU DO THONG KE',0,0,0,0,0),
								(N'SAOLUUDULIEU','BACKUP',0,0,0,0,0),
								(N'SAOLUUDULIEU','RESTORE',0,0,0,0,0),
								(N'HELP','HELPS',0,0,0,0,0)


INSERT INTO CTCN VALUES (N'DANHMUC',N'QLBH'),
						(N'QUANLYBANHANG',N'NVBH'),
						(N'THONGKE',N'NVNEW'),
						(N'SAOLUUDULIEU',N'NVNEW'),
						(N'HELP',N'NVNEW')


--SELECT *FROM dbo.CHUCNANG
--SELECT *FROM CTCN

--ALTER TABLE dbo.CHUCNANG 
--	ADD CONSTRAINT DEF_CHUCNANG_STATUS
--	DEFAULT 0 FOR STATUS


--SELECT *FROM dbo.CTCN AS ct
--		WHERE ct.DANHMUC=1

--INSERT INTO CTCN VALUES (N'NVNEW',0,0,0,0,0),
--						(N'NVBH',0,0,0,0,0)

--EXEC sp_UPDATE_CHUCNANG 1,1,1,1,1,'QUANLYBANHANG','DON DAT HANG'

--SELECT *FROM dbo.CHUCNANG WHERE MACN = N'QUANLYBANHANG' AND TENCHUCNANG = N'DON DAT HANG'


--SELECT *FROM dbo.CTCN
--SELECT *FROM dbo.CHUCNANG


--INSERT INTO dbo.PHANQUYEN
--(
--    MAQH,
--    TENQH,
--    GHICHU
--)
--VALUES
--(   N'NVKT', -- MAQH - nchar(50)
--    N'Nhân Viên Kế Toán', -- TENQH - nvarchar(100)
--    N''  -- GHICHU - nvarchar(100)
--    )

--CREATE PROCEDURE sp_Insert_PHANQUYEN
--@MAQH NCHAR(50),
--@TENQH NVARCHAR(100),
--@GHICHU NVARCHAR(100)
--AS
--BEGIN
--	INSERT INTO PHANQUYEN VALUES (@MAQH,@TENQH,@GHICHU)
--END
--GO

--sp_Insert_PHANQUYEN 'NVBV',N'Nhân Viên Bảo Vệ',''


--SELECT *FROM dbo.PHANQUYEN

--SELECT *FROM dbo.CHUCNANG
--SELECT *FROM CTCN


--EXEC sp_INSERT_CTCN_UPDATE_CHUCNANG N'NVKT',0,1,0,0,0,N'QUANLYBANHANG','DON DAT HANG',1,1,1,1,1

--SELECT *FROM dbo.CHUCNANG
--SELECT *FROM dbo.CTCN

--EXEC dbo.sp_Insert_PHIEUXUAT @MANV = 15150001,                         -- int
--                             @MAKH = 12120001,                         -- int
--                             @MASP = 16160001,                         -- int
--                             @SLX = 2,                          -- int
--                             @NGAYXUAT = '2018-05-07 20:39:09', -- datetime
--                             @PHANTRAM = 0.0                    -- real


--							 SELECT *FROM dbo.KHACHHANG
--SELECT *FROM dbo.PHIEUXUAT
--SELECT *FROM dbo.CTPX

--DELETE FROM dbo.CTPX
--DELETE FROM dbo.PHIEUXUAT


--UPDATE dbo.TAIKHOAN SET Password = 123 WHERE ID = 15152019

--CREATE PROCEDURE sp_UPDATE_TAIKHOAN
--@ID INT,
--@PASS INT
--AS
--BEGIN
--    UPDATE dbo.TAIKHOAN SET Password=@PASS WHERE ID=@ID
--END
--GO


SELECT *FROM dbo.CTSP
SELECT *FROM dbo.NHACC

